# Finding 0020 Analysis

## Entries

### SS-LINK-ENDPOINT
Links do not require distinct source and target documents. Both endpoints of a link may reside within the same document (internal/self-referential links). The link state structure `Link = (source: set<ContentId>, target: set<ContentId>, type: Tumbler)` does not impose a constraint `doc(source) != doc(target)`. The only structural requirement is that source and target name valid content identities; they may name content within the same document.

This corrects a prior assumption that internal links would be rejected. The backend creates the link successfully and returns a valid link address.

**Why it matters for spec:** The precondition for `create_link` must NOT include `doc(source) != doc(target)`. The link endpoint type is unconstrained with respect to document identity: `forall link : Link :: doc(link.source) == doc(link.target)` is a valid state. Any spec predicate that assumes links are cross-document must be relaxed.

**Code references:** Test `links/self_referential_link`

**Provenance:** Finding 0020

### PRE-LINK-CREATE
The precondition for link creation does not require source and target to be in different documents. An internal link where `home_doc == source_doc == target_doc` is valid. The operation succeeds, returning a link address under the home document's address space.

Concrete example:
- Document `1.1.0.1.0.1` contains text including "glossary" and "Glossary"
- `create_link(home_doc=1.1.0.1.0.1, source="glossary", target="Glossary", type="jump")`
- Result: success, link address `1.1.0.1.0.1.0.2.1`

**Why it matters for spec:** Defines the valid input domain for link creation. The precondition is: source content exists AND target content exists AND home_doc is valid. No cross-document constraint.

**Code references:** Test `links/self_referential_link`

**Provenance:** Finding 0020

### ST-LINK-CREATE
When an internal link is created, it is bidirectionally traversable just like cross-document links. `follow_link(link, "target")` returns the target text and `follow_link(link, "source")` returns the source text, regardless of whether both endpoints are in the same document.

Concrete example:
- Before: Document contains "glossary" and "Glossary", no links
- Operation: `create_link(source="glossary", target="Glossary", same_document=true, type="jump")`
- After: Link exists; `follow_link(link, "target")` returns "Glossary"; `follow_link(link, "source")` returns "glossary"

**Why it matters for spec:** The postcondition for link creation is uniform â€” internal and cross-document links have identical traversal semantics. No special case is needed in the spec for same-document links.

**Code references:** Test `links/self_referential_link`

**Provenance:** Finding 0020

### EC-SELF-LINK
Internal links (source and target in the same document) are a valid edge case that the system handles without error. This contradicts an earlier assumption documented in `scenario_bidirectional_links` that internal links would be rejected. The system treats same-document links identically to cross-document links.

Related edge cases from other tests extend the link model further:
- Same span can have multiple links to different targets (`links/overlapping_links_different_targets`)
- Intermediate nodes can be both link sources and link targets (`links/link_chain`)

**Why it matters for spec:** Bounded checking should include same-document link scenarios. Any Alloy model of links should not constrain `source.doc != target.doc`.

**Code references:** Tests `links/self_referential_link`, `links/link_chain`, `links/overlapping_links_different_targets`

**Provenance:** Finding 0020
