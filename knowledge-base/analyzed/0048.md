# Finding 0048 Analysis

## Entries

### ST-FOLLOWLINK
**What happens:** FOLLOWLINK retrieves link endset I-addresses from the link orgl, then converts them to V-addresses using a specified document's POOM. The call chain is: `link2sporglset()` extracts I-addresses from the link orgl at the requested endset position (0.1, 0.2, or 0.3) via `retrieverestricted()` — no POOM check occurs at this stage. Then `linksporglset2specset()` converts I-addresses to V-addresses by looking them up in the specified `homedoc`'s POOM. The conversion calls `span2spanset()` which uses `retrieverestricted()` against the document's orgl. If an I-address has no POOM mapping, `retrieverestricted` returns NULL and the I-address is silently dropped — no V-span is added to the result.

**Why it matters for spec:** FOLLOWLINK's postcondition is not simply "return the endset" — it is filtered through a specific document's POOM. The result depends on which document's POOM is queried (the `homedoc` parameter). The same link endset can produce different V-address results (or empty results) depending on which document context is used. Formally: `followlink(link, whichend, homedoc) = { v | ∃ i ∈ endset(link, whichend) : poom.homedoc(v) = i }`. If no such v exists for any i, the result is empty.

**Code references:**
- `link2sporglset()`: `backend/sporgl.c:67-95` — extracts I-addresses from link orgl, no POOM check
- `linksporglset2specset()`: `backend/sporgl.c:97+` — converts I-addresses to V-specs via homedoc POOM
- `span2spanset()`: `backend/orglinks.c:425-449` — if `retrieverestricted` returns NULL, I-address silently dropped (lines 446-448)
- `dofollowlink()`: `backend/do1.c:227-236` — orchestrates the two-phase process

**Concrete example:**
- Link L has to-endset containing I-address `a`
- Document D1 has `poom.D1(1.5) = a` → FOLLOWLINK(L, TO, D1) returns `[1.5]`
- Document D2 has no POOM mapping for `a` → FOLLOWLINK(L, TO, D2) returns `[]`
- Content deleted from all documents → FOLLOWLINK(L, TO, any) returns `[]`, operation succeeds

**Provenance:** Finding 0048

### PRE-FOLLOWLINK
**What happens:** FOLLOWLINK requires: (1) the link ISA must reference an existing link orgl — if `findorgl()` returns FALSE, the operation fails; (2) the `whichend` parameter selects endset position 1, 2, or 3. There is no precondition requiring that endset I-addresses be currently referenced in any POOM. The operation succeeds even when all endset I-addresses are unreferenced, returning an empty result rather than an error.

**Why it matters for spec:** The precondition is strictly about link existence, not about liveness of the content the link points to. This is a design choice: the back end returns what permanent storage contains, and the I-to-V conversion filters based on current POOM state. A spec must not add a "liveness" precondition — empty results from unreferenced I-addresses are valid successful outcomes, not errors.

**Code references:**
- `findorgl()` check: `backend/sporgl.c:76-78` — returns FALSE if link orgl not found
- No POOM check in `link2sporglset()`: `backend/sporgl.c:67-95`

**Provenance:** Finding 0048

### EC-GHOST-LINK
**What happens:** When a link's endset contains I-addresses that are not in any document's POOM (unreferenced addresses per DEL5), FOLLOWLINK succeeds but returns empty or partial results. These are "ghost links" — the link structure is intact in the permanent layer, but its endpoints point to content with no current V-position. Three observable cases: (1) all endset I-addresses live → full result; (2) some unreferenced → partial result, only live addresses converted; (3) all unreferenced → empty result `[]`, operation still succeeds.

**Why it matters for spec:** Ghost links are not an error condition but a natural consequence of content deletion in a system with permanent I-addresses. The spec must distinguish three result states: operation failure (link doesn't exist), ghost link (link exists, result empty), and normal link (link exists, result non-empty). An empty successful result from FOLLOWLINK does NOT mean the endset is empty — it means the endset's I-addresses have no current V-position in the queried document. Reconstitution (DEL7) is always possible since I-addresses are permanent (P0).

**Code references:**
- Silent filtering: `backend/orglinks.c:446-448` — NULL context returns without adding V-spans
- Test evidence: `golden/links/orphaned_link_target_all_deleted.json` — returns `[]` with `works: true`
- DEL5 definition: unreferenced(a) ≡ a ∈ dom.ispace ∧ ¬(∃d, v : poom.d(v) = a)

**Concrete example:**
- Before: Link L has to-endset I-address `a`, document D has `poom.D(1.5) = a`
- Delete all content from D: `poom.D` no longer maps any v to `a`
- After: FOLLOWLINK(L, TO, D) → `[]`, works=true
- Reconstitution: COPY `a` into new document D2 → `poom.D2(1.1) = a` → FOLLOWLINK(L, TO, D2) → `[1.1]`

**Provenance:** Finding 0048

### INV-ITOV-FILTERING
**What happens:** Both FOLLOWLINK and RETRIEVEENDSETS share the same I-to-V conversion path that silently filters unreferenced I-addresses. The mechanism is identical: `linksporglset2specset()` calls `sporglset2vspanset()` which calls `ispan2vspanset()` → `permute()` → `span2spanset()`. At `span2spanset()`, `retrieverestricted()` searches the target document's POOM for the I-address. If not found (returns NULL), the I-address is dropped from the result without error.

**Why it matters for spec:** This is a universal invariant of all operations that convert I-addresses to V-addresses: **unreferenced I-addresses are silently excluded from V-address results**. No operation that performs I-to-V conversion will ever return a V-address for an unreferenced I-address. This is not operation-specific behavior but a property of the conversion layer itself. Formally: `∀ op returning V-addresses: v ∈ result(op) → ∃ d, i : poom.d(v) = i ∧ i ∈ dom.ispace`.

**Code references:**
- Common path: `sporglset2vspanset()` in `backend/sporgl.c` → `span2spanset()` in `backend/orglinks.c:425-449`
- FOLLOWLINK uses this via `linksporglset2specset()`: `backend/sporgl.c:97+`
- RETRIEVEENDSETS uses same via `linksporglset2specset()`: `backend/spanf1.c:190-235`

**Provenance:** Finding 0048 (sections on call chain and comparison), Finding 0035
