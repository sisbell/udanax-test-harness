# Finding 0019 Analysis

## Entries

### SS-LINK-ENDPOINT
Endsets are the mechanism for querying the V-address spans that constitute a link's source and target endpoints. The `retrieve_endsets` operation (FEBE opcode 28) returns specsets describing where a link's endpoints currently exist in V-space.

Endsets are **dynamic** — they reflect current V-positions after edits, not the positions at link creation time. This is a consequence of the dual-enfilade architecture: links are stored via I-addresses internally, but endsets are reported in V-address terms relative to the queried document.

Key structural facts:
- Endsets contain a `source` specset and a `target` specset
- Target specsets are often empty when querying from the source document, suggesting the API returns only endpoints that intersect the query specset
- When queried from a version, endsets report the version's docid rather than the original's

**Why it matters for spec**: Defines the return type and semantics of endset retrieval — the fundamental link query operation.

**Provenance**: Finding 0019, sections 1, 5, 6

### INV-LINK-CONTENT-TRACKING
Links track content by identity (I-address), not by position (V-address). This has three observable consequences:

1. **V-address shifts**: When content is inserted within or before a linked region, the endset V-addresses shift to reflect the new positions:
   ```
   Before: "Click here for info" — link on "here" at V 1.7 width 0.4
   Insert: "right " at position 1.7
   After:  "Click right here for info" — link reports 1.13 width 0.4
   ```

2. **Partial deletion shrinks endsets**: When part of a linked region is deleted, the link shrinks to cover only the surviving content:
   ```
   Before: "Click right here for info" — link on "right here" at V 1.7 width 0.10
   Delete: "right " (6 chars)
   After:  "Click here for info" — link reports 1.7 width 0.4
   ```

3. **Cross-document discovery**: A link on transcluded content is discoverable by searching the original document's I-address region:
   ```
   Doc 1: "Original shared text"
   Doc 2: "Prefix: " + vcopy("shared" from doc 1)
   Link created on "shared" in doc 2
   find_links(doc 1, "shared" region) → finds the link in doc 2
   ```

The invariant: a link's endset always covers exactly the surviving content that was originally linked, regardless of insertions, deletions, or transclusions that have occurred.

**Why it matters for spec**: This is the central invariant for link behavior — links are anchored to content identity, not positional slots. All postconditions for insert, delete, and vcopy must preserve this property.

**Code references**: Tested via `endsets/endsets_after_source_insert`, `endsets/endsets_after_source_delete`, `endsets/endsets_transcluded_source` scenarios.

**Provenance**: Finding 0019, sections 1, 2, 4

### INT-LINK-VERSION
Links created on original documents are discoverable from versions through shared content identity. When a version is created, it shares I-addresses with the original, so `find_links` on the version returns links created against the original.

Concrete example:
```
Original doc: 1.1.0.1.0.1 with link at V 1.17 width 0.4
Version:      1.1.0.1.0.1.1
find_links(version) → finds original's link
retrieve_endsets(version) → endsets report version's docid (1.1.0.1.0.1.1)
```

The endset docid is rewritten to the queried document's address, even though the link was created against the original. This means endsets are relative to the query context, not absolute.

**Why it matters for spec**: Version creation must preserve I-address sharing such that link discovery is inherited. The endset retrieval postcondition must specify docid rewriting relative to the query document.

**Provenance**: Finding 0019, section 5

### EC-PIVOT-LINK-FRAGMENTATION
When linked content is rearranged via pivot, the link's endsets become fragmented into multiple spans, and the link itself may appear duplicated in `find_links` results.

Concrete example:
```
Before: "ABCDEFGH" — link on "CD" at V 1.3 width 0.2
Pivot:  swap BC and DE
After:  "ADEBCFGH" — endsets report FOUR spans:
        - 1.2 width 0.1 (twice)
        - 1.5 width 0.1 (twice)
find_links returns the same link TWICE
```

This suggests that rearrangement can cause internal fragmentation in the enfilade structure that is visible through the endset API. The duplication may be a bug or may reflect the internal representation of fragmented spans.

**Why it matters for spec**: The postcondition for pivot/rearrange must account for endset fragmentation. The spec may need to define whether duplicated spans in endset results are normalized or left as-is. This is an edge case that constrains how rearrangement interacts with the link subsystem.

**Code references**: Tested via `endsets/endsets_after_pivot` scenario.

**Provenance**: Finding 0019, section 3

### EC-MULTISPAN-LINK-DUPLICATION
Creating a link with multiple source spans works, but `retrieve_endsets` may return duplicate spans:

```
Link source: ["First" at V 1.1, "second" at V 1.16]
Endsets return: 3 spans (1.16 appears twice)
```

This duplication in multi-span link endsets may be related to the same internal fragmentation mechanism observed with pivot (EC-PIVOT-LINK-FRAGMENTATION).

**Why it matters for spec**: Multi-span link creation postconditions must specify whether endset results are deduplicated. This observed duplication may indicate an implementation artifact rather than intended semantics.

**Code references**: Tested via `endsets/endsets_multispan_link` scenario.

**Provenance**: Finding 0019, section 7
