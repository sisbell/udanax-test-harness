# Finding 0065 Analysis

## Entries

### SS-ADDRESS-SPACE
**Detail level: Essential**

Link I-addresses are allocated per-document within element subspace 2. The full structure is:

```
account.0.document.0.element_field.element_number
```

Where `element_field` is 2 for links and 3 for text, and `element_number` is allocated monotonically within each (document, element_field) pair.

**Why it matters for spec:** Defines the address namespace partitioning — each document has an independent link allocation subspace. The element field distinguishes content types, and the element number is scoped to the document, not global.

**Concrete example:**
- Document A = `1.1.0.1.0.1`
- First link in A: `1.1.0.1.0.1.0.2.1` (element field 2, element number 1)
- Second link in A: `1.1.0.1.0.1.0.2.2` (element field 2, element number 2)
- First link in B (`1.1.0.1.0.2`): `1.1.0.1.0.2.0.2.1` (independent counter, also starts at 1)

**Code references:**
- `backend/granf2.c:158-181` — `findisatoinsertmolecule` constructs upperbound from document ISA
- `backend/do1.c:211` — `makehint(DOCUMENT, ATOM, LINKATOM, docisaptr, &hint)` sets document scope
- `backend/do2.c:78-84` — `makehint` copies `docisaptr` to `hintptr->hintisa`

**Provenance:** Finding 0065

### ST-ADDRESS-ALLOC
**Detail level: Essential**

MAKELINK allocates link I-addresses using query-and-increment within a document-bounded region of the global granfilade. The allocation uses the same `findisatoinsertmolecule` mechanism as text allocation but with different bounds.

**What happens:**
1. `upperbound` is set to `docISA.2.3` (bounding search to the document's link subspace)
2. `findpreviousisagr` finds the highest existing link I-address below that bound
3. If no links exist yet (`lowerbound < docISA.2.2`), allocate at `docISA.2.2.1`
4. Otherwise, increment from `lowerbound` (the highest existing link's address) by `0.1`

**Why it matters for spec:** The allocation postcondition for MAKELINK is: the new link's I-address is strictly greater than all existing link I-addresses in the same document, and independent of link I-addresses in other documents.

**Concrete example (before/after):**
- Before: Document A has link at `docA.2.1`; Document B has no links
- MAKELINK on B → B gets link at `docB.2.1` (B's own first link)
- MAKELINK on A → A gets link at `docA.2.2` (consecutive with A's existing link, unaffected by B)

**Code references:**
- `backend/granf2.c:162` — `tumblerincrement(&hintptr->hintisa, 2, hintptr->atomtype + 1, &upperbound)` sets document-scoped bound
- `backend/granf2.c:164` — `findpreviousisagr` performs bounded search
- `backend/granf2.c:171-175` — allocation logic: first-link vs increment cases

**Provenance:** Finding 0065

### INV-MONOTONIC
**Detail level: Essential**

Link I-address allocation within a document is strictly monotonically increasing. Each MAKELINK on document D produces an I-address greater than all previous link I-addresses in D. This holds independently per document — interleaving MAKELINK calls across documents does not break monotonicity within any single document.

**Why it matters for spec:** Strengthens the monotonicity invariant: it holds per-(document, element_field) partition, not just globally. The invariant is `forall d: Document, forall l1 l2: Link | l1 created before l2 in d => iaddr(l1) < iaddr(l2)`.

**Concrete example:**
- MAKELINK(docA) → `docA.2.1`
- MAKELINK(docB) → `docB.2.1`
- MAKELINK(docA) → `docA.2.2` (monotonic within A despite intervening B operation)

**Code references:**
- `backend/granf2.c:174` — `tumblerincrement(&lowerbound, 0, 1, isaptr)` guarantees increment from highest existing

**Provenance:** Finding 0065

### FC-DOC-ISOLATION
**Detail level: Essential**

MAKELINK on document B does not affect the link I-address allocation state of document A. The allocation counter is implicit (derived from bounded query), and the query bound is constructed from the target document's own I-address. Therefore, link creation in one document is a no-op with respect to all other documents' link allocation state.

**What happens:** The `upperbound` in `findisatoinsertmolecule` is derived from `hintptr->hintisa` (the document's I-address), not from any global state. The `findpreviousisagr` search is bounded to `[lowerbound, docISA.2.3)`, so it only sees entries in the target document's link subspace.

**Why it matters for spec:** Frame condition for MAKELINK: `forall d': Document | d' != d => link_state(d') unchanged after MAKELINK(d)`. This enables independent reasoning about per-document operations and confirms there is no global link allocation bottleneck or shared mutable state.

**Code references:**
- `backend/granf2.c:162` — upperbound constructed from document-specific `hintisa`
- `backend/granf2.c:164` — `findpreviousisagr` confined to document's address subspace
- `backend/do1.c:211` — `makehint` binds allocation to specific document

**Provenance:** Finding 0065

