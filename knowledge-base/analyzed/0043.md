# Finding 0043 Analysis

## Entries

### ST-VERSION-CREATE

**What happens**: `CREATENEWVERSION(d)` copies only the text subspace (`1.x` V-positions) from the source document's POOM into the new version. The link subspace (`0.x` / internally `2.x`) is not copied. The mechanism is in `docreatenewversion` which calls `doretrievedocvspanfoo` to obtain a single vspan, then passes it to `docopyinternal`. The function `retrievedocumentpartofvspanpm` returns only the document's V-dimension displacement and width — `cdsp.dsas[V]` and `cwid.dsas[V]` — which point to position `1` (the text subspace start). The link subspace at positions before `1` is structurally outside this vspan.

**Why it matters for spec**: This refines the ST-VERSION-CREATE postcondition from finding 0007. The postcondition is not `references(version) = references(original)` unconditionally — it is `text_references(version) = text_references(original) AND link_references(version) = {}`. The version starts with all text content identity from the original but an empty link subspace. This is intentional behavior per EWD-021. The formal spec must distinguish between text-subspace copying (which happens) and link-subspace copying (which does not).

**Concrete example**:
```
Pre-state:
  Source document vspanset:
    at 0 for 0.1    (link subspace — link orgl ISA)
    at 1 for 1      (text subspace — permascroll I-addresses)

CREATENEWVERSION(source) → version

Post-state:
  Version vspanset: at 1.1 for 0.15   (text subspace only)
  Source vspanset:  at 0 for 0.1, at 1 for 1   (unchanged)
```

**Code references**:
- `do1.c:264-303` — `docreatenewversion()` retrieves vspan and calls `docopyinternal`
- `do1.c:305-313` — `doretrievedocvspanfoo()` (identical to `doretrievedocvspan`)
- `orglinks.c:155-162` — `retrievedocumentpartofvspanpm()` returns V-displacement and width starting at text position

**Provenance**: Finding 0043

### FC-SUBSPACE

**What happens**: CREATENEWVERSION preserves the source document's link subspace unchanged while copying the text subspace to the version. The source document's vspanset (including its `0.x` link entries) is unmodified after version creation. The version receives a new, empty link subspace — it has no POOM-level link entries. This is an asymmetric frame condition: the source's link subspace is preserved (standard frame condition), and the version's link subspace is initialized to empty (postcondition on the new document).

**Why it matters for spec**: This extends FC-SUBSPACE beyond single-document operations to cover version creation. The frame condition is: `link_subspace(source)` is unchanged by `CREATENEWVERSION(source)`. The postcondition adds: `link_subspace(version) = {}`. For Dafny, this can be verified as part of the version-create postcondition — the version's POOM projection onto subspace `0.x`/`2.x` is empty.

**Code references**:
- `do1.c:264-303` — `docreatenewversion()` only copies the vspan from `retrievedocumentpartofvspanpm`, which excludes links
- `orglinks.c:155-162` — `retrievedocumentpartofvspanpm()` returns displacement starting at text position 1, not 0

**Provenance**: Finding 0043

### INT-LINK-TRANSCLUSION

**What happens**: Despite CREATENEWVERSION not copying link subspace entries to the version's POOM, `find_links` still works on the version. This is because link discovery operates on content identity (I-addresses), not POOM structure. The version shares permascroll I-addresses with the source (via the text subspace copy), and links are indexed by those I-addresses. The `find_links` operation searches I-space for links whose endpoints intersect the query's I-addresses, so any document sharing content identity with a linked document will discover those links — regardless of whether that document has link subspace entries in its own POOM.

**Why it matters for spec**: The formal spec must model two completely independent mechanisms: (1) POOM link storage — the `0.x`/`2.x` subspace storing link orgl ISAs within a document, and (2) link discovery — the `find_links` operation that searches by content identity intersection. These are decoupled: a document can have no link subspace entries but still return links via `find_links`, because link discovery is content-identity-based. The spec should state: `find_links(doc) = {L | L.endpoint_content ∩ content_ids(doc) ≠ ∅}`, independent of `link_subspace(doc)`.

**Concrete example**:
```
Source (has link "here" on "Click here for info"):
  POOM: at 0 for 0.1 (link), at 1 for 1 (text)
  find_links → [link_id]

Version of source:
  POOM: at 1.1 for 0.15 (text only, no link subspace)
  find_links → [link_id]  (SAME result, via content identity)

retrieve_contents on version returns:
  ["Click here for info", "1.1.0.1.0.1.0.2.1"]
  (text content includes embedded link address from I-space)
```

**Code references**:
- `find_links` searches by I-address intersection (content identity based)
- Golden test `version_with_links` verifies link discovery works on versions

**Provenance**: Finding 0043

### SS-DUAL-ENFILADE

**What happens**: The document POOM V-space displacement (`cdsp.dsas[V]`) points to the start of the text subspace at position `1`, not to position `0` (the link subspace). The link subspace occupies V-positions before the document's recorded displacement. This means `retrievedocumentpartofvspanpm` — which reads `cdsp.dsas[V]` and `cwid.dsas[V]` — returns a vspan covering only the text region. The link subspace is structurally "outside" the document's primary vspan as returned by this function, accessible only through `retrievevspansetpm` which explicitly constructs separate link and text spans.

**Why it matters for spec**: The state structure has an asymmetry: the document's V-dimension displacement/width pair describes the text subspace only. The link subspace exists at lower V-positions but is not captured by the document's primary vspan. Two different retrieval functions expose different views: `retrievedocumentpartofvspanpm` returns text-only, `retrievevspansetpm` returns both subspaces. The formal model should note that the "document extent" (displacement + width) covers text, while links are a separate structural component at lower V-addresses.

**Code references**:
- `orglinks.c:155-162` — `retrievedocumentpartofvspanpm()` reads `cdsp.dsas[V]` (text start) and `cwid.dsas[V]` (text width)
- `orglinks.c:173-220` — `retrievevspansetpm()` constructs separate link and text spans using `is1story` check

**Provenance**: Finding 0043
