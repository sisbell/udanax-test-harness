# Finding 0064 Analysis

## Entries

### ST-DELETE

**What happens**: DELETE operates exclusively on the POOM enfilade — it removes V-to-I mappings by pruning bottom crums (height-0 nodes) via `disown` + `subtreefree`. The I-addresses themselves continue to exist in the granfilade (which is append-only) and in the spanfilade (which has no delete operation). Other documents that reference the same I-addresses through transclusion are completely unaffected — their POOM mappings remain intact.

The critical consequence: after DELETE removes a V-span, the I-addresses that were mapped become unreferenced *in this document only*. The content bytes persist in the granfilade, the spanfilade still indexes them, and any other document sharing those I-addresses retains its mapping.

**Why it matters for spec**: Extends the ST-DELETE postcondition with explicit I-space semantics. DELETE destroys the local V-to-I mapping but does NOT destroy the I-addresses themselves. Formally:

```
delete(D, vspan) ⟹
  (1) ∀ v ∈ vspan : v ∉ dom(poom(D))          -- V-to-I mapping removed
  (2) ∀ i ∈ iaddrs(vspan) : i ∈ granfilade    -- content bytes persist
  (3) ∀ D' ≠ D : poom(D') unchanged           -- other documents unaffected
```

**Code references**:
- `backend/edit.c:76-84` — `deletend` case 1: `disown` + `subtreefree` on bottom crums
- `backend/do1.c:162-171` — `dodeletevspan`: calls `deletevspanpm` (granf only, no spanf call)

**Concrete example**:
```
Before DELETE "BC" (V-addresses 1.2-1.3):
  POOM(D): V(1.1)→I(5.1)  V(1.2)→I(5.2)  V(1.3)→I(5.3)  V(1.4)→I(5.4)
  Granfilade: I(5.1)="A"  I(5.2)="B"  I(5.3)="C"  I(5.4)="D"
  Other doc T (transcluded "BC"): V(2.1)→I(5.2)  V(2.2)→I(5.3)

After DELETE(D, 1.2, 0.2):
  POOM(D): V(1.1)→I(5.1)  V(1.2)→I(5.4)
  Granfilade: I(5.1)="A"  I(5.2)="B"  I(5.3)="C"  I(5.4)="D"  ← UNCHANGED
  Other doc T: V(2.1)→I(5.2)  V(2.2)→I(5.3)                    ← UNCHANGED
```

**Provenance**: Finding 0064

### INV-IADDR-IMMUTABILITY

**What happens**: I-addresses, once allocated in the granfilade, are permanent and immutable. The granfilade is append-only — `inserttextingranf` always allocates fresh addresses at the end. There is no mechanism to reuse, reassign, or deallocate I-addresses. DELETE frees the POOM bottom crums that *reference* I-addresses, but the I-addresses themselves persist in the granfilade unconditionally.

This means: (1) the set of allocated I-addresses grows monotonically, (2) the content associated with any I-address never changes, and (3) no operation can cause two distinct I-addresses to become identical or one I-address to refer to different content over time.

**Why it matters for spec**: Strengthens the immutability invariant with granfilade-level evidence. The invariant is: `∀ i, t₁ < t₂ : i ∈ granfilade(t₁) ⟹ i ∈ granfilade(t₂) ∧ content(i, t₁) = content(i, t₂)`. No operation in the system — including DELETE — can remove an I-address from existence. DELETE only severs one document's *reference* to an I-address.

**Code references**:
- `backend/do1.c:27-43` — `doinsert`: calls `inserttextingranf` (append-only allocation)
- `backend/edit.c:76-84` — `deletend`: frees POOM nodes, not granfilade entries

**Provenance**: Finding 0064

### INV-DELETE-NOT-INVERSE

**What happens**: DELETE followed by INSERT of identical text does NOT restore the original document state. The V-space content is reconstructed (same characters at the same positions), but the I-space identity is entirely different. INSERT always allocates fresh I-addresses from the granfilade — it has no mechanism to reuse previously freed I-addresses. The result is that the re-inserted text has new I-addresses with no relationship to the original ones.

All relationships indexed by I-address are permanently severed: transclusions, link endpoints, version comparison results, and provenance chains. The document *looks* the same in V-space but is identity-disconnected in I-space.

**Why it matters for spec**: DELETE and INSERT are not algebraic inverses. Formally:

```
Let s = content(v) and i = iaddr(v) in state S₀
After DELETE(doc, v):            S₁ where iaddr(v) = ∅
After INSERT(doc, v, s):         S₂ where iaddr(v) = i' and i' ≠ i
                                 and content(v) = s (V-space restored)
                                 but i' ∩ i = ∅ (I-space disconnected)
```

This non-invertibility is fundamental, not a bug. It follows from the append-only granfilade: once I-addresses are allocated, the allocator has moved past them and will never return them.

**Code references**:
- `backend/do1.c:27-43` — `doinsert`: always calls `inserttextingranf` for fresh I-addresses
- `backend/edit.c:31-76` — `deletend`: frees POOM mappings (V→I references), not the I-addresses themselves
- Test scenario: `febe/scenarios/provenance.py::scenario_delete_then_recopy`

**Concrete example**:
```
State S₀:
  POOM: V(1.1)→I(5.1) V(1.2)→I(5.2) V(1.3)→I(5.3) V(1.4)→I(5.4)
        "A"            "B"            "C"            "D"

After DELETE "BC":
  POOM: V(1.1)→I(5.1) V(1.2)→I(5.4)
        "A"            "D"

After INSERT "BC" at V(1.2):
  POOM: V(1.1)→I(5.1) V(1.2)→I(5.5) V(1.3)→I(5.6) V(1.4)→I(5.4)
        "A"            "B"            "C"            "D"

V-space content identical to S₀, but I(5.5) ≠ I(5.2) and I(5.6) ≠ I(5.3).
compare_versions(S₀, S₂) reports "BC" as different content.
```

**Provenance**: Finding 0064

### ST-COPY

**What happens**: COPY is the identity-preserving operation. Unlike INSERT (which allocates fresh I-addresses), COPY shares the source's existing I-addresses in the target document's POOM via `insertpm`. When used to "undelete" content — by copying from a document that still references the original I-addresses — COPY restores both the V-space content AND the I-space identity.

This establishes a clear operational taxonomy:
- **INSERT**: Creates new content identity (fresh I-addresses from granfilade)
- **COPY**: Preserves existing content identity (shares I-addresses via POOM)
- **DELETE**: Destroys the local V-to-I mapping (I-addresses become unreferenced in this document)

**Why it matters for spec**: COPY is the only mechanism for identity-preserving content restoration after DELETE. Formally:

```
Let source still map i to some V-span v_s
After DELETE(doc, v):              iaddr_doc(v) = ∅
After COPY(doc, v, source, v_s):   iaddr_doc(v) = i    -- identity restored
```

This means "undo delete" in the Xanadu model is not `INSERT(deleted_text)` but `COPY(from_version_with_original_iaddrs)`. The precondition for identity-preserving restoration is that some accessible document still references the original I-addresses.

**Code references**:
- `backend/do1.c:45-65` — `docopy`: calls `insertpm` (shares existing I-addresses) + `insertspanf`
- `febe/scenarios/provenance.py::scenario_delete_then_recopy` — demonstrates COPY restoring identity after DELETE

**Provenance**: Finding 0064

### FC-DELETE-CROSS-DOC

**What happens**: DELETE in one document has zero effect on any other document's POOM mappings. If document T transcluded content from document D (sharing I-addresses via COPY), and D subsequently deletes that content, T's POOM still maps to the shared I-addresses. T's content is unaffected — the transclusion survives the source document's deletion.

This is because DELETE operates on a single document's POOM tree only. It calls `deletend` on the target document's orgl, freeing bottom crums from that tree. Other documents' trees are separate data structures and are not touched.

**Why it matters for spec**: Frame condition for DELETE across documents: `∀ D' ≠ D : delete(D, vspan) ⟹ poom(D') = poom_before(D')`. Combined with granfilade immutability, this means the content bytes remain accessible through any other document that still references those I-addresses. A document cannot "retract" content from other documents by deleting it locally.

**Code references**:
- `backend/edit.c:31-76` — `deletend`: operates on a single orgl (document enfilade)
- `backend/orglinks.c:145-152` — `deletevspanpm`: passes a specific document's orgl to `deletend`

**Concrete example**:
```
D has "ABCD", T transcluded "BC" from D (sharing I(5.2), I(5.3))

After DELETE "BC" from D:
  D's POOM: V(1.1)→I(5.1) V(1.2)→I(5.4)          -- "BC" mapping gone from D
  T's POOM: V(2.1)→I(5.2) V(2.2)→I(5.3)          -- UNCHANGED, T still has "BC"
  Granfilade: I(5.2)="B" I(5.3)="C"               -- content bytes persist
```

**Provenance**: Finding 0064
